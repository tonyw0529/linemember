<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>會員註冊</title>
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="districtMap.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
  <style>
    * { 
      box-sizing: border-box; 
      margin: 0;
      padding: 0;
    }
    
    :root {
      --primary-color: #06c755;
      --secondary-color: #007041;
      --background-color: #f9f9f9;
      --card-color: #ffffff;
      --text-color: #333333;
      --label-color: #666666;
      --border-color: #e0e0e0;
      --error-color: #ff4d4f;
      --success-color: #52c41a;
      --border-radius: 12px;
      --input-border-radius: 8px;
      --shadow: 0 8px 24px rgba(0, 0, 0, 0.06);
    }
    
    body {
      font-family: 'Noto Sans TC', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background-color: var(--background-color);
      color: var(--text-color);
      line-height: 1.6;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    
    .container {
      width: 100%;
      max-width: 500px;
      margin: 20px auto 40px;
      padding: 0 16px;
    }
    
    .card {
      background-color: var(--card-color);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      padding: 32px 24px;
      margin-bottom: 24px;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .header {
      padding: 24px 0;
      text-align: center;
    }
    
    .logo {
      width: 80px;
      height: 80px;
      margin-bottom: 16px;
    }
    
    h1 {
      font-size: 26px;
      font-weight: 700;
      margin-bottom: 8px;
      color: var(--text-color);
    }
    
    .subtitle {
      font-size: 16px;
      color: var(--label-color);
      margin-bottom: 32px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 8px;
      color: var(--label-color);
    }
    
    input, select {
      width: 100%;
      padding: 12px 16px;
      font-size: 16px;
      border: 1px solid var(--border-color);
      border-radius: var(--input-border-radius);
      background-color: #fff;
      transition: border 0.2s ease, box-shadow 0.2s ease;
      font-family: inherit;
    }
    
    input:focus, select:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(6, 199, 85, 0.1);
    }
    
    input[type="date"] {
      appearance: none;
      padding-right: 12px;
    }
    
    .form-row {
      display: flex;
      gap: 16px;
      margin-bottom: 20px;
    }
    
    .form-col {
      flex: 1;
    }
    
    button {
      width: 100%;
      padding: 14px 24px;
      font-size: 18px;
      font-weight: 700;
      color: white;
      background-color: var(--primary-color);
      border: none;
      border-radius: var(--input-border-radius);
      cursor: pointer;
      transition: background-color 0.2s ease;
      margin-top: 8px;
    }
    
    button:hover {
      background-color: var(--secondary-color);
    }
    
    .required::after {
      content: "*";
      color: var(--error-color);
      margin-left: 4px;
    }
    
    .form-hint {
      font-size: 12px;
      color: var(--label-color);
      margin-top: 4px;
    }
    
    .input-icon {
      position: relative;
    }
    
    .input-icon input {
      padding-left: 40px;
    }
    
    .icon {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      width: 20px;
      height: 20px;
      color: var(--label-color);
    }
    
    .footer {
      text-align: center;
      padding: 24px 16px;
      color: var(--label-color);
      font-size: 14px;
      margin-top: auto;
    }
    
    /* 響應式設計 */
    @media (max-width: 600px) {
      .container {
        padding: 0 12px;
      }
      
      .card {
        padding: 24px 16px;
      }
      
      .form-row {
        flex-direction: column;
        gap: 20px;
      }
      
      h1 {
        font-size: 24px;
      }
    }
    
    /* 按鈕動畫 */
    @keyframes pulse {
      0% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.05);
      }
      100% {
        transform: scale(1);
      }
    }
    
    .pulse {
      animation: pulse 2s infinite;
    }
    
    /* 加載動畫 */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
      margin-right: 8px;
      vertical-align: middle;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* 錯誤提示 */
    .error-message {
      color: var(--error-color);
      font-size: 13px;
      margin-top: 4px;
      display: none;
    }
    
    input:invalid + .error-message {
      display: block;
    }
    
    /* 表單區段 */
    .form-section {
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 24px;
      margin-bottom: 24px;
    }
    
    .form-section-title {
      font-size: 18px;
      font-weight: 500;
      margin-bottom: 16px;
      color: var(--text-color);
    }
    
    /* 城市與區域樣式強化 */
    .location-selects {
      display: flex;
      gap: 12px;
    }
    
    .location-selects select {
      flex: 1;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>會員註冊</h1>
      <p class="subtitle">填寫資料，加入我們的會員計劃</p>
    </div>
    
    <div class="card">
      <form id="registerForm">
        <input type="hidden" id="userId" />
        
        <div class="form-section">
          <div class="form-section-title">個人資料</div>
          
          <div class="form-row">
            <div class="form-col">
              <div class="form-group">
                <label class="required" for="name">姓名</label>
                <input type="text" id="name" required placeholder="請輸入您的姓名" />
              </div>
            </div>
            <div class="form-col">
              <div class="form-group">
                <label class="required" for="nickname">暱稱</label>
                <input type="text" id="nickname" required placeholder="您希望我們如何稱呼您" />
              </div>
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-col">
              <div class="form-group">
                <label class="required" for="phone">聯絡電話</label>
                <input type="tel" id="phone" required pattern="[0-9]{10}" placeholder="請輸入手機號碼" />
                <p class="form-hint">例如：0912345678</p>
              </div>
            </div>
            <div class="form-col">
              <div class="form-group">
                <label class="required" for="email">電子郵件</label>
                <input type="email" id="email" required placeholder="example@email.com" />
              </div>
            </div>
          </div>
          
          <div class="form-group">
            <label class="required" for="birthday">生日</label>
            <input type="date" id="birthday" required max="2025-12-31" />
          </div>
        </div>
        
        <div class="form-section">
          <div class="form-section-title">居住地址</div>
          
          <div class="form-group">
            <label class="required">地區</label>
            <div class="location-selects">
              <select id="city" required></select>
              <select id="district" required></select>
            </div>
          </div>
        </div>
        
        <div class="form-section">
          <div class="form-section-title">車輛資訊</div>
          
          <div class="form-group">
            <label class="required" for="plate0">車牌號碼 1</label>
            <input type="text" id="plate0" required placeholder="例如：ABC-123 或 ABC123" />
            <p class="form-hint">所有格式都可以，系統會自動處理</p>
          </div>
          
          <div class="form-group">
            <label for="plate1">車牌號碼 2 (選填)</label>
            <input type="text" id="plate1" placeholder="例如：ABC-123 或 ABC123" />
          </div>
          
          <div class="form-group">
            <label for="plate2">車牌號碼 3 (選填)</label>
            <input type="text" id="plate2" placeholder="例如：ABC-123 或 ABC123" />
          </div>
        </div>
        
        <button type="submit" id="submitBtn">送出資料</button>
      </form>
    </div>
  </div>
  
  <div class="footer">
    © 2025 公司名稱 | 版權所有
  </div>

  <script>
    // LIFF 初始化
    async function initLiff() {
      try {
        // 基本初始化
        await liff.init({
          liffId: "2007134780-E8ynMDnW"
        });
        
        console.log('LIFF 初始化成功');
        
        // 檢查登入狀態
        if (!liff.isLoggedIn()) {
          console.log('使用者未登入，準備登入');
          liff.login();
        } else {
          console.log('使用者已登入，取得個人資料');
          const profile = await liff.getProfile();
          document.getElementById('userId').value = profile.userId;
        }
      } catch (error) {
        console.error('LIFF 初始化錯誤:', error);
        alert('LINE 登入服務暫時無法使用: ' + error.message);
      }
    }

    // 載入城市與區域選單
    function loadCityDistricts() {
      const citySelect = document.getElementById('city');
      const districtSelect = document.getElementById('district');
      
      // 檢查元素是否存在
      if (!citySelect || !districtSelect) {
        console.error('找不到城市或區域選單元素');
        return;
      }
      
      // 載入城市
      for (let city in cityDistrictMap) {
        const option = document.createElement('option');
        option.value = city;
        option.textContent = city;
        citySelect.appendChild(option);
      }
      
      // 設定城市變更事件
      citySelect.addEventListener('change', function() {
        // 清空區域選單
        districtSelect.innerHTML = '';
        
        // 檢查選擇的城市是否有對應的區域
        const districts = cityDistrictMap[this.value];
        if (!districts) {
          console.error('找不到對應的區域:', this.value);
          return;
        }
        
        // 載入區域
        districts.forEach(function(district) {
          const option = document.createElement('option');
          option.value = district;
          option.textContent = district;
          districtSelect.appendChild(option);
        });
      });
      
      // 預設選擇第一個城市
      if (citySelect.options.length > 0) {
        citySelect.selectedIndex = 0;
        citySelect.dispatchEvent(new Event('change'));
      }
    }

    // 表單提交功能
    function setupFormSubmission() {
      const form = document.getElementById('registerForm');
      const submitBtn = document.getElementById('submitBtn');
      
      form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        // 驗證表單
        if (!this.checkValidity()) {
          this.reportValidity();
          return;
        }
        
        // 更新按鈕狀態
        const originalText = submitBtn.textContent;
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="loading"></span>資料處理中...';
        
        // 組織數據
        // 格式化車牌號碼：全部大寫，移除連字符
        const formatPlate = (plate) => {
          return plate.trim().toUpperCase().replace(/-/g, '');
        };
        
        const data = {
          formType: "membership",
          lineUID: document.getElementById('userId').value,
          name: document.getElementById('name').value,
          nickName: document.getElementById('nickname').value,
          phone: document.getElementById('phone').value,
          email: document.getElementById('email').value,
          birthday: document.getElementById('birthday').value,
          city: document.getElementById('city').value,
          district: document.getElementById('district').value,
          plates0: formatPlate(document.getElementById('plate0').value),
          plates1: formatPlate(document.getElementById('plate1').value) || "",
          plates2: formatPlate(document.getElementById('plate2').value) || ""
        };
        
        try {
          // 發送資料到伺服器
          const response = await fetch("https://proxy-xr4v2vbiba-de.a.run.app/proxy", {
            method: 'POST',
            body: JSON.stringify(data),
            headers: {
              'Content-Type': 'application/json',
              'Accept': 'application/json'
            }
          });
          
          // 處理伺服器回應
          const result = await response.json();
          
          if (!response.ok) {
            throw new Error(result.message || "資料送出失敗");
          }
          
          // 顯示成功訊息
          alert(result.message || "資料已成功送出！");
          
          // 關閉視窗 (如果在 LINE 內)
          if (liff.isInClient()) {
            liff.closeWindow();
          }
          
        } catch (err) {
          console.error("送出失敗:", err);
          alert("送出失敗: " + err.message);
          
          // 恢復按鈕狀態
          submitBtn.disabled = false;
          submitBtn.textContent = originalText;
        }
      });
    }

    // 頁面載入完成後執行
    window.onload = function() {
      console.log('頁面載入完成');
      
      // 載入城市與區域選單
      loadCityDistricts();
      
      // 設定表單提交功能
      setupFormSubmission();
      
      // 載入完成後初始化 LIFF
      setTimeout(function() {
        initLiff();
      }, 500);
    };
  </script>
</body>
</html>
