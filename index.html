// 確保先移除所有 console.log 中的 getEnvironment 調用
// 保持初始化代碼最簡單

// LIFF 初始化
async function initLiff() {
  try {
    // 基本初始化
    await liff.init({
      liffId: "2007134780-E8ynMDnW"
    });
    
    console.log('LIFF 初始化成功');
    
    // 檢查登入狀態
    if (!liff.isLoggedIn()) {
      console.log('使用者未登入，準備登入');
      liff.login();
    } else {
      console.log('使用者已登入，取得個人資料');
      const profile = await liff.getProfile();
      document.getElementById('userId').value = profile.userId;
    }
  } catch (error) {
    console.error('LIFF 初始化錯誤:', error);
    alert('LINE 登入服務暫時無法使用: ' + error.message);
  }
}

// 載入城市與區域選單
function loadCityDistricts() {
  const citySelect = document.getElementById('city');
  const districtSelect = document.getElementById('district');
  
  // 檢查元素是否存在
  if (!citySelect || !districtSelect) {
    console.error('找不到城市或區域選單元素');
    return;
  }
  
  // 載入城市
  for (let city in cityDistrictMap) {
    const option = document.createElement('option');
    option.value = city;
    option.textContent = city;
    citySelect.appendChild(option);
  }
  
  // 設定城市變更事件
  citySelect.addEventListener('change', function() {
    // 清空區域選單
    districtSelect.innerHTML = '';
    
    // 檢查選擇的城市是否有對應的區域
    const districts = cityDistrictMap[this.value];
    if (!districts) {
      console.error('找不到對應的區域:', this.value);
      return;
    }
    
    // 載入區域
    districts.forEach(function(district) {
      const option = document.createElement('option');
      option.value = district;
      option.textContent = district;
      districtSelect.appendChild(option);
    });
  });
  
  // 預設選擇第一個城市
  if (citySelect.options.length > 0) {
    citySelect.selectedIndex = 0;
    citySelect.dispatchEvent(new Event('change'));
  }
}

// 頁面載入完成後執行
window.onload = function() {
  console.log('頁面載入完成');
  
  // 載入城市與區域選單
  loadCityDistricts();
  
  // 載入完成後初始化 LIFF
  setTimeout(function() {
    initLiff();
  }, 500);
  
  // 表單提交事件
  document.getElementById('registerForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    console.log('準備提交表單');
    
    // 驗證表單
    if (!this.checkValidity()) {
      this.reportValidity();
      return;
    }
    
    // 組織數據
    const data = {
      formType: "membership",
      lineUID: document.getElementById('userId').value,
      name: document.getElementById('name').value,
      nickName: document.getElementById('nickname').value,
      phone: document.getElementById('phone').value,
      email: document.getElementById('email').value,
      birthday: document.getElementById('birthday').value,
      city: document.getElementById('city').value,
      district: document.getElementById('district').value,
      plates0: document.getElementById('plate0').value.trim(),
      plates1: document.getElementById('plate1').value.trim() || "",
      plates2: document.getElementById('plate2').value.trim() || ""
    };
    
    console.log('準備送出資料:', data);
    
    try {
      // 發送資料到伺服器
      const response = await fetch("https://proxy-xr4v2vbiba-de.a.run.app/proxy", {
        method: 'POST',
        body: JSON.stringify(data),
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        }
      });
      
      // 處理伺服器回應
      const result = await response.json();
      console.log('伺服器回應:', result);
      
      if (!response.ok) {
        throw new Error(result.message || "資料送出失敗");
      }
      
      // 顯示成功訊息
      alert(result.message || "資料已成功送出！");
      
      // 關閉視窗
      if (liff.isInClient()) {
        liff.closeWindow();
      }
      
    } catch (err) {
      console.error("送出失敗:", err);
      alert("送出失敗: " + err.message);
    }
  });
};
