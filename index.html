// 更新表單提交處理函數
async function setupFormSubmission() {
  const form = document.getElementById('registerForm');
  const submitBtn = document.getElementById('submitBtn');
  
  // 獲取代理服務的訪問令牌函數
  async function getProxyToken() {
    try {
      // 從您的令牌服務器獲取令牌
      // 這裡您需要設置一個簡單的服務來提供 Google 身份令牌
      const tokenResponse = await fetch('https://your-token-service.com/get-token');
      if (!tokenResponse.ok) {
        throw new Error('無法獲取訪問令牌');
      }
      const tokenData = await tokenResponse.json();
      return tokenData.token;
    } catch (error) {
      console.error('獲取令牌失敗:', error);
      throw error;
    }
  }
  
  form.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    // 驗證表單
    if (!this.checkValidity()) {
      this.reportValidity();
      return;
    }
    
    // 檢查 userId 是否已設定
    const userId = document.getElementById('userId').value;
    if (!userId) {
      console.warn('LINE 使用者 ID 尚未取得，嘗試重新取得');
      try {
        const profile = await liff.getProfile();
        document.getElementById('userId').value = profile.userId;
      } catch (err) {
        console.error('無法取得 LINE 用戶 ID:', err);
        alert('無法取得您的 LINE 資料，請重新開啟或聯繫客服');
        return;
      }
    }
    
    // 更新按鈕狀態
    const originalText = submitBtn.textContent;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="loading"></span>資料處理中...';
    
    // 格式化車牌號碼：全部大寫，移除連字符
    const formatPlate = (plate) => {
      return plate.trim().toUpperCase().replace(/-/g, '');
    };
    
    const data = {
      formType: "membership",
      lineUID: document.getElementById('userId').value,
      name: document.getElementById('name').value,
      nickName: document.getElementById('nickname').value,
      phone: document.getElementById('phone').value,
      email: document.getElementById('email').value,
      birthday: document.getElementById('birthday').value,
      city: document.getElementById('city').value,
      district: document.getElementById('district').value,
      plates0: formatPlate(document.getElementById('plate0').value),
      plates1: formatPlate(document.getElementById('plate1').value) || "",
      plates2: formatPlate(document.getElementById('plate2').value) || ""
    };
    
    console.log('準備送出資料:', data);
    
    try {
      // 使用較長的超時時間
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 30000); // 30秒逾時
      
      // 獲取身份令牌 (方案1)
      let token;
      try {
        token = await getProxyToken();
        console.log('成功獲取訪問令牌');
      } catch (tokenError) {
        console.error('無法獲取訪問令牌:', tokenError);
        // 繼續執行，嘗試不使用令牌發送請求
        console.warn('嘗試不使用令牌發送請求');
      }
      
      // 準備請求頭
      const headers = {
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      };
      
      // 如果獲取到令牌，添加到請求頭
      if (token) {
        headers['Authorization'] = `Bearer ${token}`;
      }
      
      // 發送資料到伺服器
      const response = await fetch("https://proxy-server-xr4v2vbiba-de.a.run.app/proxy", {
        method: 'POST',
        body: JSON.stringify(data),
        headers: headers,
        signal: controller.signal
      });
      
      clearTimeout(timeoutId);
      
      console.log('伺服器回應狀態:', response.status);
      
      // 嘗試解析 JSON
      let result;
      try {
        result = await response.json();
        console.log('伺服器回應內容:', result);
      } catch (jsonError) {
        console.error('解析回應 JSON 失敗:', jsonError);
        const text = await response.text();
        console.log('回應原始文字:', text);
        throw new Error('解析伺服器回應失敗');
      }
      
      if (!response.ok) {
        throw new Error(result.message || `伺服器回應錯誤 (${response.status})`);
      }
      
      // 顯示成功訊息
      alert(result.message || "資料已成功送出！");
      
      // 關閉視窗 (如果在 LINE 內)
      if (liff.isInClient()) {
        liff.closeWindow();
      }
      
    } catch (err) {
      console.error("送出失敗:", err);
      
      // 顯示更友善的錯誤訊息
      let errorMessage = "送出失敗";
      
      if (err.name === 'AbortError') {
        errorMessage += ": 連線逾時，請稍後再試";
      } else if (err.message) {
        errorMessage += ": " + err.message;
      }
      
      alert(errorMessage);
      
      // 恢復按鈕狀態
      submitBtn.disabled = false;
      submitBtn.textContent = originalText;
    }
  });
}
