<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>會員註冊</title>
  
  <!-- 引入 LINE LIFF SDK -->
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  
  <!-- 引入縣市鄉鎮地圖資料 -->
  <script src="districtMap.js"></script>
  
  <!-- 您的樣式檔案 -->
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="container">
    <h1>會員註冊</h1>
    
    <!-- 註冊表單 -->
    <form id="registerForm" class="needs-validation" novalidate>
      <!-- 隱藏的 userId 欄位 -->
      <input type="hidden" id="userId" name="userId">
      
      <!-- 姓名 -->
      <div class="form-group">
        <label for="name">姓名 <span class="required">*</span></label>
        <input type="text" id="name" name="name" required>
      </div>
      
      <!-- 暱稱 -->
      <div class="form-group">
        <label for="nickname">暱稱</label>
        <input type="text" id="nickname" name="nickname">
      </div>
      
      <!-- 手機號碼 -->
      <div class="form-group">
        <label for="phone">手機號碼 <span class="required">*</span></label>
        <input type="tel" id="phone" name="phone" pattern="09[0-9]{8}" required>
        <div class="invalid-feedback">請輸入有效的手機號碼 (格式: 09xxxxxxxx)</div>
      </div>
      
      <!-- 電子郵件 -->
      <div class="form-group">
        <label for="email">電子郵件</label>
        <input type="email" id="email" name="email">
        <div class="invalid-feedback">請輸入有效的電子郵件地址</div>
      </div>
      
      <!-- 生日 -->
      <div class="form-group">
        <label for="birthday">生日 <span class="required">*</span></label>
        <input type="date" id="birthday" name="birthday" required>
      </div>
      
      <!-- 縣市 -->
      <div class="form-group">
        <label for="city">縣市 <span class="required">*</span></label>
        <select id="city" name="city" required>
          <option value="">請選擇縣市</option>
          <!-- 縣市選項將由 JavaScript 動態添加 -->
        </select>
      </div>
      
      <!-- 區域 -->
      <div class="form-group">
        <label for="district">區域 <span class="required">*</span></label>
        <select id="district" name="district" required>
          <option value="">請先選擇縣市</option>
        </select>
      </div>
      
      <!-- 車牌號碼 -->
      <div class="form-group">
        <label for="plate0">車牌號碼 #1 <span class="required">*</span></label>
        <input type="text" id="plate0" name="plate0" placeholder="例如: ABC-1234" required>
      </div>
      
      <div class="form-group">
        <label for="plate1">車牌號碼 #2 (選填)</label>
        <input type="text" id="plate1" name="plate1" placeholder="例如: ABC-1234">
      </div>
      
      <div class="form-group">
        <label for="plate2">車牌號碼 #3 (選填)</label>
        <input type="text" id="plate2" name="plate2" placeholder="例如: ABC-1234">
      </div>
      
      <!-- 送出按鈕 -->
      <div class="form-group">
        <button type="submit" id="submitBtn" class="btn-primary">送出資料</button>
      </div>
    </form>
  </div>

  <!-- 您的腳本 -->
  <script>
    // LIFF 初始化
    document.addEventListener('DOMContentLoaded', async function() {
      try {
        await liff.init({ liffId: "YOUR_LIFF_ID" });
        console.log("LIFF 初始化成功");
        
        // 檢查是否在 LINE 環境中
        if (liff.isLoggedIn() && liff.isInClient()) {
          const profile = await liff.getProfile();
          document.getElementById('userId').value = profile.userId;
          console.log("已取得 LINE 用戶 ID:", profile.userId);
        } else if (!liff.isInClient()) {
          console.log("不在 LINE 應用程式中，無法取得用戶 ID");
          // 這裡可以添加測試用的用戶 ID
          document.getElementById('userId').value = "test_user_" + Date.now();
        }
        
        // 設置縣市區域選擇器
        setupCityDistrictSelectors();
        
        // 設置表單提交處理
        setupFormSubmission();
        
      } catch (err) {
        console.error("LIFF 初始化失敗:", err);
      }
    });

    // 設置縣市區域選擇器 - 使用 districtMap.js 中的資料
    function setupCityDistrictSelectors() {
      const citySelect = document.getElementById('city');
      const districtSelect = document.getElementById('district');
      
      // 確保 cityDistrictMap 已加載
      if (typeof cityDistrictMap === 'undefined') {
        console.error('縣市地圖資料未加載');
        return;
      }
      
      // 填充縣市選項
      for (const city in cityDistrictMap) {
        const option = document.createElement('option');
        option.value = city;
        option.textContent = city;
        citySelect.appendChild(option);
      }
      
      // 當縣市選擇變更時，更新區域選項
      citySelect.addEventListener('change', function() {
        const selectedCity = this.value;
        
        // 清空並重設區域選擇器
        districtSelect.innerHTML = '<option value="">請選擇區域</option>';
        
        if (selectedCity && cityDistrictMap[selectedCity]) {
          cityDistrictMap[selectedCity].forEach(district => {
            const option = document.createElement('option');
            option.value = district;
            option.textContent = district;
            districtSelect.appendChild(option);
          });
        }
      });
    }

    // 更新表單提交處理函數
    async function setupFormSubmission() {
      const form = document.getElementById('registerForm');
      const submitBtn = document.getElementById('submitBtn');
      
      // 獲取代理服務的訪問令牌函數
      async function getProxyToken() {
        try {
          // 從令牌服務獲取令牌
          const tokenResponse = await fetch('https://token-service-xr4v2vbiba-de.a.run.app/get-token');
          if (!tokenResponse.ok) {
            throw new Error('無法獲取訪問令牌');
          }
          const tokenData = await tokenResponse.json();
          return tokenData.token;
        } catch (error) {
          console.error('獲取令牌失敗:', error);
          throw error;
        }
      }
      
      form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        // 驗證表單
        if (!this.checkValidity()) {
          this.reportValidity();
          return;
        }
        
        // 檢查 userId 是否已設定
        const userId = document.getElementById('userId').value;
        if (!userId) {
          console.warn('LINE 使用者 ID 尚未取得，嘗試重新取得');
          try {
            const profile = await liff.getProfile();
            document.getElementById('userId').value = profile.userId;
          } catch (err) {
            console.error('無法取得 LINE 用戶 ID:', err);
            alert('無法取得您的 LINE 資料，請重新開啟或聯繫客服');
            return;
          }
        }
        
        // 更新按鈕狀態
        const originalText = submitBtn.textContent;
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="loading"></span>資料處理中...';
        
        // 格式化車牌號碼：全部大寫，移除連字符
        const formatPlate = (plate) => {
          return plate.trim().toUpperCase().replace(/-/g, '');
        };
        
        const data = {
          formType: "membership",
          lineUID: document.getElementById('userId').value,
          name: document.getElementById('name').value,
          nickName: document.getElementById('nickname').value,
          phone: document.getElementById('phone').value,
          email: document.getElementById('email').value,
          birthday: document.getElementById('birthday').value,
          city: document.getElementById('city').value,
          district: document.getElementById('district').value,
          plates0: formatPlate(document.getElementById('plate0').value),
          plates1: formatPlate(document.getElementById('plate1').value) || "",
          plates2: formatPlate(document.getElementById('plate2').value) || ""
        };
        
        console.log('準備送出資料:', data);
        
        try {
          // 使用較長的超時時間
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 30000); // 30秒逾時
          
          // 嘗試獲取身份令牌
          let token;
          try {
            token = await getProxyToken();
            console.log('成功獲取訪問令牌');
          } catch (tokenError) {
            console.error('無法獲取訪問令牌:', tokenError);
            // 繼續執行，嘗試不使用令牌發送請求
            console.warn('嘗試不使用令牌發送請求');
          }
          
          // 準備請求頭
          const headers = {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          };
          
          // 如果獲取到令牌，添加到請求頭
          if (token) {
            headers['Authorization'] = `Bearer ${token}`;
          }
          
          // 發送資料到伺服器
          const response = await fetch("https://proxy-server-xr4v2vbiba-de.a.run.app/proxy", {
            method: 'POST',
            body: JSON.stringify(data),
            headers: headers,
            signal: controller.signal
          });
          
          clearTimeout(timeoutId);
          
          console.log('伺服器回應狀態:', response.status);
          
          // 嘗試解析 JSON
          let result;
          try {
            result = await response.json();
            console.log('伺服器回應內容:', result);
          } catch (jsonError) {
            console.error('解析回應 JSON 失敗:', jsonError);
            const text = await response.text();
            console.log('回應原始文字:', text);
            throw new Error('解析伺服器回應失敗');
          }
          
          if (!response.ok) {
            throw new Error(result.message || `伺服器回應錯誤 (${response.status})`);
          }
          
          // 顯示成功訊息
          alert(result.message || "資料已成功送出！");
          
          // 關閉視窗 (如果在 LINE 內)
          if (liff.isInClient()) {
            liff.closeWindow();
          }
          
        } catch (err) {
          console.error("送出失敗:", err);
          
          // 顯示更友善的錯誤訊息
          let errorMessage = "送出失敗";
          
          if (err.name === 'AbortError') {
            errorMessage += ": 連線逾時，請稍後再試";
          } else if (err.message) {
            errorMessage += ": " + err.message;
          }
          
          alert(errorMessage);
          
          // 恢復按鈕狀態
          submitBtn.disabled = false;
          submitBtn.textContent = originalText;
        }
      });
    }
  </script>
</body>
</html>
